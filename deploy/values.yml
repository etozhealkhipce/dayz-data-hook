app:
  name: dayz-tracker-app
  namespace: sskd
  replicas: 1
  port: 5000
  healthPath: /health

  image:
    repository: ghcr.io/etozhealkhipce/dayz-data-hook
    tag: latest
    pullPolicy: Always

  imagePullSecrets:
    - name: dayz-tracker-ghcr-secret

  initContainers:
    - name: migrate
      image: ghcr.io/etozhealkhipce/dayz-data-hook:latest
      command: ["sh", "-c"]
      args:
        - |
          apk add --no-cache postgresql-client
          echo "WAITING FOR DATABASE..."
          until pg_isready -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}" 2>/dev/null; do
            echo "DATABASE UNAVAILABLE - SLEEPING"
            sleep 2
          done
          echo "RUNNING MIGRATIONS..."
          npx drizzle-kit push
          echo "MIGRATIONS COMPLETE"

  env:
    NODE_ENV: production
    PORT: "5000"
    PGHOST:
      valueFrom:
        secretKeyRef:
          name: dayz-tracker-db-secrets
          key: PGHOST
    PGPORT:
      valueFrom:
        secretKeyRef:
          name: dayz-tracker-db-secrets
          key: PGPORT
    PGDATABASE:
      valueFrom:
        secretKeyRef:
          name: dayz-tracker-db-secrets
          key: PGDATABASE
    PGUSER:
      valueFrom:
        secretKeyRef:
          name: dayz-tracker-db-secrets
          key: PGUSER
    PGPASSWORD:
      valueFrom:
        secretKeyRef:
          name: dayz-tracker-db-secrets
          key: PGPASSWORD
  envFrom:
    - secretRef:
        name: dayz-tracker-db-secrets

  resources:
    requests:
      memory: "256Mi"
      cpu: "200m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  ingress:
    enabled: true
    host: dayz-tracker-app.sskd.tech
