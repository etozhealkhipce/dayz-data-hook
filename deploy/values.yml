app:
  name: dayz-tracker-app
  namespace: sskd
  replicas: 1
  port: 80
  healthPath: /api/health

  image:
    repository: ghcr.io/etozhealkhipce/dayz-data-hook
    tag: latest
    pullPolicy: Always

  imagePullSecrets:
    - name: dayz-tracker-ghcr-secret

  initContainers:
    - name: migrate
      image: ghcr.io/etozhealkhipce/dayz-data-hook:latest
      command: ["sh", "-c"]
      args:
        - |
          echo "WAITING FOR DATABASE..."
          until pg_isready -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}" 2>/dev/null; do
            echo "DATABASE UNAVAILABLE - SLEEPING"
            sleep 2
          done
          echo "RUNNING MIGRATIONS..."
          npx drizzle-kit push
          echo "MIGRATIONS COMPLETE"

  env:
    NODE_ENV: production
    PORT: "5000"
    PGHOST: dayz-tracker-db
    PGPORT: "5432"
    PGDATABASE: dayz_tracker
  envFrom:
    - secretRef:
        name: dayz-tracker-app-secrets

  resources:
    requests:
      memory: "256Mi"
      cpu: "200m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  ingress:
    enabled: true
    host: dayz-logger.sskd.tech
